name: Check for Upstream Updates and Send Email

on:
  schedule:
    - cron: '0 10 * * 0'  # æ¯å‘¨å¤©ä¸‹åˆ18ç‚¹ä¸­å›½æ—¶é—´è¿è¡Œ
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  check-updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 1  # åªæ‹‰å–æœ€æ–°çš„æäº¤

      - name: Set Upstream Repository if not exists
        run: |
          git remote | grep upstream || git remote add upstream https://github.com/hehonghui/awesome-english-ebooks.git
          git fetch upstream

      - name: Check for New Commits
        id: check_updates
        run: |
          NEW_COMMITS=$(git rev-list HEAD..upstream/master --count)
          echo "::set-output name=new_commits::$NEW_COMMITS"

      - name: Configure Git Identity
        run: |
          git config --global user.email ${{ secrets.GIT_EMAIL }}  # è®¾ç½®æäº¤è€…é‚®ç®±
          git config --global user.name ${{ secrets.GIT_NAME }} # è®¾ç½®æäº¤è€…åç§°

      - name: Sync with Upstream
        if: steps.check_updates.outputs.new_commits != '0'
        run: |
          set -e  # é‡åˆ°é”™è¯¯æ—¶åœæ­¢æ‰§è¡Œ
          git merge upstream/master --allow-unrelated-histories --strategy-option theirs || (echo "Merge failed, rolling back" && git merge --abort)
          git push origin master

      - name: Send Email if Updates Found
        if: steps.check_updates.outputs.new_commits != '0'
        uses: devellany/send-mail@v1.0.2
        with:
          host: 'smtp.qq.com'  # qqé‚®ç®±ä¸»æœº
          port: 465  # SMTP ç«¯å£ï¼Œé€šå¸¸ä¸º465æˆ–587
          account: ${{ secrets.EMAIL }}  # é‚®ç®±åœ°å€ï¼Œä½¿ç”¨GitHub Secretsç®¡ç†
          password: ${{ secrets.APP_PASSWORD }}  # é‚®ç®±å¯†ç æˆ–åº”ç”¨å¯†ç ï¼Œä½¿ç”¨GitHub Secrets
          sender: 'éå…¸å‹ç¨‹åºğŸ¦'  # å‘ä»¶äººçš„åå­—
          from: ${{ secrets.EMAIL }}  # å‘ä»¶äººçš„é‚®ç®±åœ°å€
          to: ${{ secrets.TARGET_EMAIL }}  # æ”¶ä»¶äººçš„é‚®ç®±åœ°å€ï¼Œå¯ä»¥ç”¨é€—å·åˆ†éš”å¤šä¸ªé‚®ç®±
          subject: "Repository Updates"  # é‚®ä»¶ä¸»é¢˜
          body: "Found ${{ steps.check_updates.outputs.new_commits }} new updates in the repository"  # é‚®ä»¶æ­£æ–‡ï¼ŒåŒ…å«æ›´æ–°çš„æäº¤æ•°é‡
          contentType: text/plain
